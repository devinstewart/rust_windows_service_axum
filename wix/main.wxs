<?xml version='1.0' encoding='windows-1252'?>

<?if $(sys.BUILDARCH) = x64 or $(sys.BUILDARCH) = arm64 ?>
    <?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
<?else ?>
    <?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
<?endif ?>

<!-- Add the Wix FireWall Extension schema in addition to the Wix schema -->
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi' xmlns:fire='http://schemas.microsoft.com/wix/FirewallExtension'>

    <Product
        Id='*'
        Name='Rust Axum Service'
        UpgradeCode='8D9F8AE4-15EB-4124-84DE-29F1360AB95C'
        Manufacturer='Devin Stewart'
        Language='1033'
        Codepage='1252'
        Version='$(var.Version)'>

        <Package Id='*'
            Keywords='Installer'
            Manufacturer='Devin Stewart'
            InstallerVersion='450'
            Languages='1033'
            Compressed='yes'
            InstallScope='perMachine'
            SummaryCodepage='1252'
            />

        <MajorUpgrade
            Schedule='afterInstallInitialize'
            DowngradeErrorMessage='A newer version of [ProductName] is already installed. Setup will now exit.'/>

        <Media Id='1' Cabinet='media1.cab' EmbedCab='yes' DiskPrompt='CD-ROM #1'/>
        <Property Id='DiskPrompt' Value='Rust Axum Service Installation'/>

        <Directory Id='TARGETDIR' Name='SourceDir'>
            <Directory Id='$(var.PlatformProgramFilesFolder)' Name='PFiles'>
                <Directory Id='APPLICATIONFOLDER' Name='Rust Axum Service'>
                    <Component Id='binary0' Guid='*'>
                        <File
                            Id='exe0'
                            Name='rust_windows_service_axum.exe'
                            DiskId='1'
                            Source='$(var.CargoTargetBinDir)\rust_windows_service_axum.exe'
                            KeyPath='yes'>
                            <!-- Add the firewall exception that wiil allow the service to be accessed from the network -->
                            <fire:FirewallException
                                Id='firewallException0'
                                Name='Rust Axum Service'
                                Scope='any'
                                Protocol='tcp'
                                Profile='all'
                                />
                        </File>
                        <!-- Create a service that will run the executable -->
                        <ServiceInstall
                            Id='ServiceInstaller'
                            Type='ownProcess'
                            Vital='yes'
                            Name='Rust Axum Service'
                            DisplayName='Rust Axum Service'
                            Description='A Service that listens for HTTP requests on port 3000'
                            Start='auto'
                            Account="[SERVICEACCOUNT]"
                            Password="[SERVICEPASSWORD]"
                            ErrorControl='normal' />
                        <!-- Start the service after installation -->
                        <ServiceControl Id='StartService' Start='install' Name='Rust Axum Service' Wait='yes' />
                    </Component>
                  </Directory>
            </Directory>
        </Directory>

        <Feature
            Id='Binaries'
            Title='Application'
            Description='Installs the executable for the Rust Axum Service, creates a firewall exception, and installs the service.'
            Level='1'
            ConfigurableDirectory='APPLICATIONFOLDER'
            AllowAdvertise='no'
            Display='expand'
            Absent='disallow'>

            <ComponentRef Id='binary0'/>
        </Feature>

        <SetProperty Id='ARPINSTALLLOCATION' Value='[APPLICATIONFOLDER]' After='CostFinalize'/>

        <UI>
            <UIRef Id='WixUI_FeatureTree'/>            
            <Publish Dialog='WelcomeDlg' Control='Next' Event='NewDialog' Value='CustomizeDlg' Order='99'>1</Publish>
            <Publish Dialog='CustomizeDlg' Control='Back' Event='NewDialog' Value='WelcomeDlg' Order='99'>1</Publish>
        </UI>
    </Product>
</Wix>
